<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- JS -->
	<script src="../../../scripts/buildfire.js"></script>
	<script src="../../../scripts/buildfire/services/notifications/localNotifications.js"></script>

</head>
<body>
	<br>
	<br>
	<button onclick="requestPermissions()">Request Permissions</button><br>
	<span id="outputPR"></span><br>

	<button onclick="schedule()">Schedule</button><br>
	<span id="countDown"></span> <span id="outputS"></span><br>

	<button onclick="cancel()">Cancel</button><br>
	<span id="outputC"></span><br>
</body>
<script type="text/javascript">
	var intervalId, notificationId, countDown, actionItem, bodyText, secondsToWait;

	buildfire.datastore.onUpdate(function(obj){
		parseData(obj.data);
	});


	function parseData(data){
		if(!data) return;

		bodyText = (data.bodyText) ? data.bodyText : 'sample body text';
		actionItem = (data.actionItem) ? data.actionItem : {sampleData: 'foo'};
		secondsToWait = (data.secondsToWait) ? data.secondsToWait : 10;
	}

	buildfire.datastore.get(function(err, obj){
		parseData(obj.data);
	});

	function requestPermissions(){
		buildfire.notifications.localNotification.requestPermission(function(err, permissionsGranted){
			var message = (permissionsGranted) ? "permissions granted" : "permissions rejected";

			document.getElementById("outputPR").innerHTML = message;
		});
	}

	function schedule(){
		countDown = secondsToWait;

		var sendTime = new Date();
		sendTime.setSeconds(sendTime.getSeconds() + secondsToWait);

		var options = {
			title: (actionItem && actionItem.title ) ? actionItem.title : '',
			text: bodyText,
			data: actionItem,
			at: sendTime,
			returnToPluginInstanceId: '' //optional
		};

		buildfire.notifications.localNotification.schedule(options, function (err, data) {
			notificationId = (data.id) ? data.id : null;

			var notificationIdDisplay = notificationId || "";

			document.getElementById("outputS").innerHTML = "Scheduled notification " + notificationIdDisplay;
		});

		document.getElementById("countDown").innerHTML = countDown;
		countDown = countDown - 1;

		intervalId = setInterval(function(){
			document.getElementById("countDown").innerHTML = countDown;
			countDown = countDown - 1;

			if(countDown < 0){
				clearInterval(intervalId);
			}

		}, 1000);
	}

	function cancel(){
		buildfire.notifications.localNotification.cancel(notificationId, function(){
			document.getElementById("outputC").innerHTML = "canceled notification  " + notificationId;
		});
	}

	//Handle notification onClick event
	buildfire.notifications.localNotification.onClick = function(data){
		alert(JSON.stringify(data));
	};

</script>
</html>